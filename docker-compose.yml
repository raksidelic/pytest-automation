version: '3'
services:
  # 1. TEST RUNNER
  pytest-tests:
    build: .
    container_name: pytest-test-runner
    environment:
      - ARANGO_URL=http://arangoDB:8529
      - SELENIUM_REMOTE_URL=http://selenoid:4444/wd/hub
      - BROWSER=${BROWSER:-chrome}
      - DOCKER_ENV=true 
      - BASE_URL=https://www.saucedemo.com

      # POSTGRES INJECTION
      - POSTGRESQL_HOST=${POSTGRESQL_HOST}
      - POSTGRESQL_PORT=${POSTGRESQL_PORT}
      - POSTGRESQL_DB=${POSTGRESQL_DB}
      - POSTGRESQL_USER=${POSTGRESQL_USER}
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}

      # AI
      - AI_PROVIDER=${AI_PROVIDER}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL}
      - OPENAI_MODEL=${OPENAI_MODEL}
    volumes:
      - ./allure-results:/app/allure-results
      - ./logs:/app/logs
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      selenoid:
        condition: service_started
    # Parallel execution configuration
    command: >
      sh -c "pytest -n ${WORKER_COUNT:-2} 
      --alluredir=allure-results 
      --clean-alluredir 
      ${TARGET_TESTS}"
    networks:
      - shared-network

  # 2. SELENOID (Automatic architecture: official Aerokube image is multi-arch)
  selenoid:
    image: aerokube/selenoid:1.11.3
    container_name: selenoid
    volumes:
      - "./config:/etc/selenoid"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./logs:/opt/selenoid/logs"
      - "./allure-results:/opt/selenoid/video"
    environment:
      - DOCKER_API_VERSION=1.45
      - OVERRIDE_VIDEO_OUTPUT_DIR=${PWD}/allure-results
    # Dynamic browser configuration file selection (filled by start_tests.py)
    command: ["-conf", "/etc/selenoid/${BROWSERS_JSON}", "-log-output-dir", "/opt/selenoid/logs", "-video-output-dir", "/opt/selenoid/video", "-container-network", "shared-network", "-limit", "10", "-video-recorder-image", "${VIDEO_RECORDER_IMAGE}"]
    ports:
      - "4444:4444"
    networks:
      - shared-network

  # 3. SELENOID UI (Automatic architecture: official Aerokube image is multi-arch)
  selenoid-ui:
    image: aerokube/selenoid-ui:1.10.11
    container_name: selenoid-ui
    depends_on:
      - selenoid
    ports:
      - "8080:8080"
    command: ["--selenoid-uri", "http://selenoid:4444"]
    networks:
      - shared-network

networks:
  shared-network:
    external: true