stages:
  - test
  - report

variables:
  # --- DEÄžÄ°ÅžÄ°KLÄ°K 1: ARTIK HER ÅžEYÄ° KAYDEDECEK ---
  RECORD_VIDEO: "true" 
  TAKE_SCREENSHOT: "true"
  BROWSER: "chrome"
  ARANGO_DB_NAME: $ARANGO_DB_NAME
  ARANGO_USER: $ARANGO_USER
  ARANGO_PASSWORD: $ARANGO_PASSWORD

run_tests:
  stage: test
  tags:
    - mac-m3-runner
  
  script:
    # 1. Temizlik
    - docker-compose down --remove-orphans || true
    - docker rm -f selenoid selenoid-ui pytest-test-runner || true
    # Ã–nceden kalmÄ±ÅŸ zombileri temizle
    - docker rm -f $(docker ps -a -q --filter ancestor=selenoid/video-recorder:latest-release) || true
    - docker rm -f $(docker ps -a -q --filter ancestor=seleniarm/standalone-chromium:latest) || true
    
    # 2. Ä°majlarÄ± HazÄ±rla
    - docker pull selenoid/video-recorder:latest-release
    - docker pull seleniarm/standalone-chromium:latest
    
    # 3. AÄŸ AyarÄ±
    - docker network create qa-network || true
    - docker network connect qa-network arangoDB || true
    
    # 4. KlasÃ¶rler
    - mkdir -p videos allure-results logs
    - chmod -R 777 videos allure-results logs
    
    # 5. BaÅŸlat
    - docker-compose up --build --exit-code-from pytest-tests

  # --- DEÄžÄ°ÅžÄ°KLÄ°K 2: GARANTÄ°LÄ° TEMÄ°ZLÄ°K ---
  after_script:
    - echo "ðŸ§¹ Temizlik baÅŸlÄ±yor..."
    - docker-compose down
    # Selenoid'in oluÅŸturduÄŸu video kaydedicileri bul ve yok et
    - docker rm -f $(docker ps -a -q --filter ancestor=selenoid/video-recorder:latest-release) || true
    # Selenoid'in oluÅŸturduÄŸu tarayÄ±cÄ±larÄ± bul ve yok et
    - docker rm -f $(docker ps -a -q --filter ancestor=seleniarm/standalone-chromium:latest) || true
    - docker rm -f $(docker ps -a -q --filter ancestor=seleniarm/standalone-firefox:latest) || true
    - echo "âœ¨ Ortam tertemiz yapÄ±ldÄ±."

  artifacts:
    when: always
    paths:
      - allure-results/
      - videos/
    expire_in: 3 days

generate_report:
  stage: report
  image: frankescobar/allure-docker-service
  tags:
    - mac-m3-runner
  script:
     - allure generate -c allure-results -o allure-report
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
  needs:
    - run_tests
  when: always