stages:
  - test
  - report

variables:
  PYTHONDONTWRITEBYTECODE: "1"
  # after_script iÃ§in varsayÄ±lan bir deÄŸer atÄ±yoruz (UyarÄ±yÄ± susturur)
  BROWSERS_JSON: "browsers_intel.json"

run_tests:
  stage: test
  # Runner'Ä±n Docker executor kullandÄ±ÄŸÄ± iÃ§in imaj belirtmek iyi pratiktir
  image: docker:latest 
  tags:
    - mac-m3-runner
  
  script:
    # --- KRÄ°TÄ°K DÃœZELTME BAÅLANGICI ---
    # Docker imajÄ± Alpine Linux tabanlÄ±dÄ±r. Python'u ve Docker Compose'u kuruyoruz.
    - apk add --no-cache python3 py3-pip docker-compose
    # --- KRÄ°TÄ°K DÃœZELTME BÄ°TÄ°ÅÄ° ---

    # 1. Ortam DosyasÄ± (.env) HazÄ±rlÄ±ÄŸÄ±
    - echo "ARANGO_URL=http://arangoDB:8529" > .env
    - echo "ARANGO_DB_NAME=$ARANGO_DB_NAME" >> .env
    - echo "ARANGO_USER=$ARANGO_USER" >> .env
    - echo "ARANGO_PASSWORD=$ARANGO_PASSWORD" >> .env
    - echo "Ortam dosyasÄ± hazÄ±rlandÄ±."
    
    # 2. AÄŸ HazÄ±rlÄ±ÄŸÄ±
    - docker network create shared-network || true
    
    # 3. KlasÃ¶r Ä°zinleri
    - mkdir -p videos allure-results logs
    - chmod -R 777 videos allure-results logs
    
    # 4. SÄ°HÄ°RLÄ° BAÅLANGIÃ‡ ğŸš€
    - python3 start_tests.py

  after_script:
    # Variables kÄ±smÄ±nda varsayÄ±lan bir BROWSERS_JSON tanÄ±mladÄ±ÄŸÄ±mÄ±z iÃ§in
    # burasÄ± artÄ±k hata veya uyarÄ± vermeden Ã§alÄ±ÅŸacak.
    - docker-compose down --remove-orphans

  artifacts:
    when: always
    paths:
      - allure-results/
      - videos/
      - logs/
    expire_in: 3 days

generate_report:
  stage: report
  image: frankescobar/allure-docker-service
  tags:
    - mac-m3-runner
  script:
     - allure generate -c allure-results -o allure-report
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
  needs:
    - run_tests
  when: always