stages:
  - quality_check
  - test
  - report

variables:
  # Python'un bytecode (.pyc) oluÅŸturmasÄ±nÄ± engeller
  PYTHONDONTWRITEBYTECODE: "1"
  
  # Screenshot her zaman aÃ§Ä±k
  TAKE_SCREENSHOT: "true"

  # --- VÄ°DEO KAYIT AYARLARI (Dropdown MenÃ¼) ---
  RECORD_VIDEO:
    value: "on_failure"  # VarsayÄ±lan deÄŸer
    options:
      - "true"
      - "false"
      - "on_failure"
      - "on_success"
    description: "Video KayÄ±t Stratejisi"

# --- 1. AÅžAMA: KALÄ°TE VE GÃœVENLÄ°K KONTROLÃœ (SHIFT LEFT) ---
static_analysis:
  stage: quality_check
  image: python:3.13.11-slim
  tags:
    - mac-m3-runner
  script:
    - echo "ðŸš€ Installing Quality Gates (Ruff & Bandit)..."
    - pip install ruff bandit

    # 1. RUFF: Modern Linter (Kod Stili ve Hata KontrolÃ¼)
    - echo "ðŸ”Ž Running Ruff (Linter & Formatter Check)..."
    # GitLab Code Quality raporu oluÅŸturur (Dashboard'da gÃ¶rÃ¼nÃ¼r)
    - ruff check . --output-format=gitlab > gl-code-quality-report.json || true 
    # HatalarÄ± konsola da basar
    - ruff check .
    
    # 2. BANDIT: GÃ¼venlik TaramasÄ± (Security Scan)
    - echo "ðŸ›¡ï¸ Running Bandit (Security Scan)..."
    # -r: recursive (tÃ¼m dosyalar), -ll: level low (tÃ¼m riskleri gÃ¶r), -ii: confidence high
    - bandit -r . -ll -ii

  artifacts:
    reports:
      codequality: gl-code-quality-report.json
    when: always
  # Bu aÅŸama baÅŸarÄ±sÄ±z olursa diÄŸerleri Ã§alÄ±ÅŸmasÄ±n (Quality Gate)
  allow_failure: false 

# --- 2. AÅžAMA: TEST KOÅžUMU ---
run_tests:
  stage: test
  image: docker:29.1.2
  tags:
    - mac-m3-runner
  
  script:
    # 1. BAÄžIMLILIKLARI YÃœKLE
    - apk add --no-cache python3 py3-pip docker-compose
    - pip3 install python-dotenv --break-system-packages || pip3 install python-dotenv

    # 2. ORTAM (.env) DOSYASINI HAZIRLA
    - echo "ARANGO_URL=http://arangoDB:8529" > .env
    - echo "ARANGO_DB_NAME=$ARANGO_DB_NAME" >> .env
    - echo "ARANGO_USER=$ARANGO_USER" >> .env
    - echo "ARANGO_PASSWORD=$ARANGO_PASSWORD" >> .env

    # AI
    - echo "AI_PROVIDER=$AI_PROVIDER" >> .env
    - echo "GEMINI_API_KEY=$GEMINI_API_KEY" >> .env
    - echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> .env
    - echo "GEMINI_MODEL=$GEMINI_MODEL" >> .env
    - echo "OPENAI_MODEL=$OPENAI_MODEL" >> .env
    
    # Dropdown'dan seÃ§ilen deÄŸeri .env'ye yazÄ±yoruz
    - echo "RECORD_VIDEO=$RECORD_VIDEO" >> .env
    
    - echo "Ortam dosyasÄ± oluÅŸturuldu."
    
    # 3. AÄž AYARLARI
    - docker network create shared-network || true
    - docker network connect shared-network arangoDB || true
    
    # 4. KLASÃ–R Ä°ZÄ°NLERÄ°
    - mkdir -p videos allure-results logs
    - chmod -R 777 videos allure-results logs

    - docker rm -f selenoid selenoid-ui pytest-test-runner || true
    
    # 5. AKILLI BAÅžLATMA ðŸš€
    - python3 start_tests.py

  after_script:
    - BROWSERS_JSON=ignore_me docker-compose down --remove-orphans

  artifacts:
    when: always
    paths:
      - allure-results/
      - videos/
      - logs/
    expire_in: 3 days

# --- 3. AÅžAMA: RAPORLAMA ---
generate_report:
  stage: report
  image: frankescobar/allure-docker-service
  tags:
    - mac-m3-runner
  script:
     - allure generate -c allure-results -o allure-report
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
  needs:
    - run_tests
  when: always