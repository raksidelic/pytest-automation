stages:
  - test
  - report

variables:
  # GitLab Settings'den gelenler dÄ±ÅŸÄ±nda bunlarÄ± tanÄ±mlÄ±yoruz
  # DOCKER_HOST ve diÄŸer ayarlar runner konfigÃ¼rasyonuna gÃ¶re deÄŸiÅŸebilir
  PYTHONDONTWRITEBYTECODE: "1"

run_tests:
  stage: test
  tags:
    # Ä°ster mac-m3-runner kullan, ister linux-runner. Script otomatik uyum saÄŸlar.
    - mac-m3-runner 
  
  script:
    # 1. Ortam DosyasÄ± (.env) HazÄ±rlÄ±ÄŸÄ± (Secrets Injection)
    - echo "ARANGO_URL=http://arangoDB:8529" > .env
    - echo "ARANGO_DB_NAME=$ARANGO_DB_NAME" >> .env
    - echo "ARANGO_USER=$ARANGO_USER" >> .env
    - echo "ARANGO_PASSWORD=$ARANGO_PASSWORD" >> .env
    - echo "Ortam dosyasÄ± hazÄ±rlandÄ±."
    
    # 2. AÄŸ HazÄ±rlÄ±ÄŸÄ± (DÄ±ÅŸ aÄŸ kullanÄ±yorsan)
    - docker network create shared-network || true
    # DB servisi baÅŸka bir yerde Ã§alÄ±ÅŸÄ±yorsa burayÄ± ona gÃ¶re ayarlarsÄ±n
    # EÄŸer DB de compose iÃ§indeyse bu satÄ±ra gerek kalmayabilir.
    
    # 3. KlasÃ¶r Ä°zinleri
    - mkdir -p videos allure-results logs
    - chmod -R 777 videos allure-results logs
    
    # 4. SÄ°HÄ°RLÄ° BAÅLANGIÃ‡ ğŸš€
    # Docker pull, rm, up iÅŸlemlerini ve mimari seÃ§imini bu script yapar.
    - python3 start_tests.py

  after_script:
    # Test bitince (baÅŸarÄ±lÄ±/baÅŸarÄ±sÄ±z) ortamÄ± temizle
    - docker-compose down --remove-orphans

  artifacts:
    when: always
    paths:
      - allure-results/
      - videos/ # EÄŸer video kaydÄ± aÃ§arsan buraya dÃ¼ÅŸer
      - logs/
    expire_in: 3 days

generate_report:
  stage: report
  image: frankescobar/allure-docker-service
  tags:
    - mac-m3-runner
  script:
     - allure generate -c allure-results -o allure-report
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
  needs:
    - run_tests
  when: always